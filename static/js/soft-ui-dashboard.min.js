"use strict";

// Initialize PerfectScrollbar for Windows
(function() {
    if (navigator.platform.indexOf("Win") > -1) {
        if (document.getElementsByClassName("main-content")[0]) {
            const mainContent = document.querySelector(".main-content");
            new PerfectScrollbar(mainContent);
        }
        if (document.getElementsByClassName("sidenav")[0]) {
            const sidenav = document.querySelector(".sidenav");
            new PerfectScrollbar(sidenav);
        }
        if (document.getElementsByClassName("navbar-collapse")[0]) {
            const navbarCollapse = document.querySelector(".navbar:not(.navbar-expand-lg) .navbar-collapse");
            new PerfectScrollbar(navbarCollapse);
        }
        if (document.getElementsByClassName("fixed-plugin")[0]) {
            const fixedPlugin = document.querySelector(".fixed-plugin");
            new PerfectScrollbar(fixedPlugin);
        }
    }
})();

// Initialize navbar blur
navbarBlurOnScroll("navbarBlur");

// Initialize tooltips
const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
const tooltipList = tooltipTriggerList.map(function(element) {
    return new bootstrap.Tooltip(element);
});

// Input focus functions
function focused(element) {
    if (element.parentElement.classList.contains("input-group")) {
        element.parentElement.classList.add("focused");
    }
}

function defocused(element) {
    if (element.parentElement.classList.contains("input-group")) {
        element.parentElement.classList.remove("focused");
    }
}

// Set attributes helper
function setAttributes(element, attributes) {
    Object.keys(attributes).forEach(key => {
        element.setAttribute(key, attributes[key]);
    });
}

// Initialize input groups
if (document.querySelectorAll(".input-group").length !== 0) {
    const allInputs = document.querySelectorAll("input.form-control");
    allInputs.forEach(input => setAttributes(input, {
        onfocus: "focused(this)",
        onfocusout: "defocused(this)"
    }));
}

// Fixed Plugin handling
if (document.querySelector(".fixed-plugin")) {
    const fixedPlugin = document.querySelector(".fixed-plugin");
    const fixedPluginButton = document.querySelector(".fixed-plugin-button");
    const fixedPluginButtonNav = document.querySelector(".fixed-plugin-button-nav");
    const fixedPluginCard = document.querySelector(".fixed-plugin .card");
    const fixedPluginCloseButton = document.querySelectorAll(".fixed-plugin-close-button");
    const navbar = document.getElementById("navbarBlur");
    const buttonNavbarFixed = document.getElementById("navbarFixed");

    if (fixedPluginButton) {
        fixedPluginButton.onclick = function() {
            fixedPlugin.classList.toggle("show");
        };
    }

    if (fixedPluginButtonNav) {
        fixedPluginButtonNav.onclick = function() {
            fixedPlugin.classList.toggle("show");
        };
    }

    fixedPluginCloseButton.forEach(button => {
        button.onclick = function() {
            fixedPlugin.classList.remove("show");
        };
    });

    document.querySelector("body").onclick = function(e) {
        if (e.target !== fixedPluginButton &&
            e.target !== fixedPluginButtonNav &&
            !e.target.closest(".fixed-plugin .card")) {
            fixedPlugin.classList.remove("show");
        }
    };

    if (navbar && navbar.getAttribute("navbar-scroll") === "true") {
        buttonNavbarFixed.setAttribute("checked", "true");
    }
}

// Navbar blur function
function navbarBlurOnScroll(id) {
    const navbar = document.getElementById(id);
    if (!navbar) return;

    const navbarScrollActive = navbar.getAttribute("navbar-scroll") === "true";
    const classes = ["position-sticky", "blur", "shadow-blur", "mt-4", "left-auto", "top-1", "z-index-sticky"];

    window.onscroll = debounce(function() {
        if (navbarScrollActive) {
            if (window.scrollY > 5) {
                navbar.classList.add(...classes);
            } else {
                navbar.classList.remove(...classes);
            }
        }
    }, 10);
}

// Debounce helper
function debounce(func, wait) {
    let timeout;
    return function() {
        const context = this;
        const args = arguments;
        clearTimeout(timeout);
        timeout = setTimeout(() => {
            func.apply(context, args);
        }, wait);
    };
}

// Sidenav
const iconNavbarSidenav = document.getElementById("iconNavbarSidenav");
const iconSidenav = document.getElementById("iconSidenav");
const sidenav = document.getElementById("sidenav-main");
const body = document.getElementsByTagName("body")[0];
const className = "g-sidenav-pinned";

function toggleSidenav() {
    if (body.classList.contains(className)) {
        body.classList.remove(className);
    } else {
        body.classList.add(className);
        sidenav.classList.add("bg-white");
        iconSidenav.classList.remove("d-none");
    }
}

if (iconNavbarSidenav) {
    iconNavbarSidenav.addEventListener("click", toggleSidenav);
}

if (iconSidenav) {
    iconSidenav.addEventListener("click", toggleSidenav);
}

// Default sidenav state
window.addEventListener("load", function() {
    if (sidenav) {
        sidenav.classList.add("bg-white");
    }
});

// Resize handler
window.addEventListener("resize", function() {
    if (sidenav) {
        sidenav.classList.add("bg-white");
    }
});